<?xml version="1.0" standalone="no"?>

<kickstart>

<post>

<!-- change eth0 to be dhcp and mac address neutral -->
<file name="/etc/sysconfig/network-scripts/ifcfg-eth0">
DEVICE=eth0                                            
BOOTPROTO=dhcp                                       
ONBOOT=yes     
</file>

<!-- change network file to not have hostname of gateway -->
<file name="/etc/sysconfig/network">
NETWORKING=yes
</file>

<!-- Download the EC2 Modules/Kernel. -->
#/bin/rm /boot/vmlinuz*
#/bin/rm /boot/xen-syms*
cd /tmp
wget http://&Kickstart_PrivateAddress;/ec2/&ec2_kernelTar;
cd /
tar xzf /tmp/&ec2_kernelTar;

mkinitrd --builtin=ehci-hcd --builtin=ohci-hcd --builtin=uhci-hcd --builtin=xenblk /boot/initrd-&ec2_kernelVersion;  &ec2_kernelVersion;
<!-- Fix-up Grub  More Hacking-->
<file name="/boot/grub/grub-orig.conf" mode="append">
title Rocks-EC2 (&ec2_kernel;)
	root (hd0,0)
	kernel /boot/&ec2_kernel;  ro root=LABEL=/ rhgb quiet
	initrd /boot/initrd-&ec2_kernelVersion;
</file>

/bin/sed -i /boot/grub/grub-orig.conf -e "s/^default=0/default=1/"

<!-- remove /install if it exists it is in the wrong place -->
if [ -d /install ]; then
     /bin/rm -rf /install
fi

<file name="/etc/motd" mode="append">
EC2-enabled Client
</file>

<!-- Get the user's authorized key as root's key using Amazon published method-->
<file name="/etc/rc.d/init.d/ec2-root-ssh" perms="755">
<![CDATA[#!/bin/sh
# $Id: ec2-client.xml,v 1.11 2010/01/15 04:17:46 phil Exp $
#
# chkconfig: 2345 99 40
# description: ec2 ssh key access
#
. /etc/rc.d/init.d/functions

RETVAL=0

copykeys() {
if [ ! -d /root/.ssh ] ; then
        mkdir -p /root/.ssh
        chmod 700 /root/.ssh
fi
# Fetch public key using HTTP
curl http://169.254.169.254/2009-04-04//meta-data/public-keys/0/openssh-key > /tmp/my-key  2>/dev/null
if [ $? -eq 0 ] ; then
	cat /tmp/my-key >> /root/.ssh/authorized_keys
	chmod 700 /root/.ssh/authorized_keys
	rm /tmp/my-key
   	return 0
else
	return -1
fi
}

case "$1" in
   start)
	echo -n "Adding User-Supplied EC2 Root SSH Key"
	copykeys 
	RETVAL=$?
	echo
	[ $RETVAL -eq 0 ] 
	;;

  stop)
      echo -n "EC2 Root SSH Key "
	[ $RETVAL -eq 0 ]
	;;

  restart|reload)
   	$0 stop
   	$0 start
   	RETVAL=$?
	;;
  *)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $RETVAL
]]>
</file>

chkconfig --add ec2-root-ssh

if [ ! -d /mnt/ec2image ]; then
	mkdir -p /mnt/ec2image
fi
</post>

</kickstart> 

